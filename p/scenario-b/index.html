<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0f0f10" />

<!-- Scenario B share preview -->
<title>Wait‚Ä¶ what is this?</title>
<meta name="description" content="I‚Äôve never seen this before‚Ä¶" />

<meta property="og:type" content="website" />
<meta property="og:title" content="Wait‚Ä¶ what is this?" />
<meta property="og:description" content="I‚Äôve never seen this before‚Ä¶" />
<meta property="og:image" content="https://xstajayx.github.io/message-media-space/p/scenario-b/previewb.png" />
<meta property="og:url" content="https://xstajayx.github.io/message-media-space/p/scenario-b/" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Wait‚Ä¶ what is this?" />
<meta name="twitter:description" content="I‚Äôve never seen this before‚Ä¶" />
<meta name="twitter:image" content="https://xstajayx.github.io/message-media-space/p/scenario-b/previewb.png" />

<style>
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;
    background:#0f0f10;
    color:#fff;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    overflow:hidden;
  }

  .appbar{
    height:56px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 14px;
    background:rgba(28,28,30,.92);
    border-bottom:1px solid rgba(255,255,255,.06);
    backdrop-filter: blur(10px);
  }
  .left{display:flex; align-items:center; gap:10px; min-width:0;}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:7px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    font-size:12px; color:#ddd; white-space:nowrap;
  }
  .dot{
    width:8px;height:8px;border-radius:999px;
    background:#ff3b30;
    box-shadow:0 0 12px rgba(255,59,48,.45);
    animation: blink 1s infinite;
  }
  @keyframes blink{50%{opacity:.15}}
  .title{
    font-weight:700; letter-spacing:.2px;
    max-width: 50vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .right{display:flex; align-items:center; gap:10px;}
  .iconBtn{
    width:36px;height:36px;border-radius:12px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    color:#fff; display:flex;align-items:center;justify-content:center;
    font-weight:900; cursor:pointer; user-select:none;
  }

  .wrap{
    height:calc(100vh - 56px);
    display:flex; align-items:center; justify-content:center;
    padding:14px;
  }
  .frame{
    width:min(460px, 92vw);
    aspect-ratio: 9 / 16;
    border-radius:22px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.08);
    background:#000;
    box-shadow:0 18px 70px rgba(0,0,0,.6);
    position:relative;
    transform: translateZ(0);
  }
  canvas{ width:100%; height:100%; display:block; }

  .hud{
    position:absolute; inset:0; pointer-events:none;
    display:flex; flex-direction:column; justify-content:space-between;
    padding:12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    letter-spacing:.08em; text-transform:uppercase;
  }
  .hudTop,.hudBottom{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
  .hudBox{
    background: rgba(0,0,0,.42);
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    padding:8px 10px;
    font-size:11px;
    color: rgba(255,255,255,.88);
  }
  .hudBox .small{display:block; margin-top:6px; opacity:.8; font-size:10px;}
  .statusRow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
  .tag{
    padding:6px 8px; border-radius:999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    font-size:10px;
  }
  .tag.warn{background: rgba(255,59,48,.12); border-color: rgba(255,59,48,.18);}
  .tag.ok{background: rgba(52,199,89,.12); border-color: rgba(52,199,89,.18);}

  .box{
    position:absolute;
    border:2px solid rgba(255,255,255,.7);
    border-radius:10px;
    box-shadow: 0 0 16px rgba(255,255,255,.18);
    opacity:0;
    pointer-events:none;
  }
  .box.on{opacity:1; animation: boxPulse .8s infinite;}
  @keyframes boxPulse{50%{opacity:.45}}

  .dialogBackdrop{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(10px);
    z-index:200;
    padding:18px;
  }
  .dialog{
    width:min(360px, 92vw);
    background:#1c1c1e;
    border:1px solid rgba(255,255,255,.10);
    border-radius:20px;
    box-shadow:0 24px 80px rgba(0,0,0,.70);
    padding:16px;
    text-align:center;
  }
  .dialog h3{ margin:0 0 8px; font-size:16px; font-weight:750; letter-spacing:.2px; }
  .dialog p{ margin:0 0 14px; color:#cfcfcf; font-size:14px; line-height:1.45; }
  .dialog .row{ display:flex; gap:10px; }
  .btn{
    flex:1;
    border:none;
    border-radius:14px;
    padding:12px 14px;
    font-weight:750;
    cursor:pointer;
  }
  .btnPrimary{ background:#3a82f7; color:#fff; }
  .btnGhost{ background:rgba(255,255,255,.06); color:#fff; border:1px solid rgba(255,255,255,.10); }

  #flash{
    position:fixed; inset:0;
    background:#fff;
    opacity:0;
    pointer-events:none;
    z-index:300;
    transition: opacity .08s linear;
  }

  .shake{animation: shake .12s infinite;}
  @keyframes shake{
    0%{transform:translate(0,0)}
    25%{transform:translate(1px,-1px)}
    50%{transform:translate(-1px,1px)}
    75%{transform:translate(1px,1px)}
    100%{transform:translate(0,0)}
  }

  #tapHint{
    position:fixed;
    left:12px; right:12px;
    bottom: calc(12px + env(safe-area-inset-bottom));
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(28,28,30,.88);
    color:#d6d6d6;
    font-size:12px;
    letter-spacing:.06em;
    text-align:center;
    z-index:120;
    opacity:.92;
    pointer-events:none;
  }

  /* === JUMPSCARE OVERLAY (better) === */
  #scare{
    position:fixed; inset:0;
    display:none;
    z-index:260;
    background:#000;
    align-items:center;
    justify-content:center;
  }
  #scare.show{ display:flex; }

  .scareWrap{
    width:min(560px, 96vw);
    aspect-ratio: 1 / 1;
    border-radius: 26px;
    overflow:hidden;
    position:relative;
    transform: scale(.88);
    filter: contrast(1.25) saturate(.85);
    box-shadow: 0 0 140px rgba(255,255,255,.06);
    animation: scareIn 1.15s cubic-bezier(.1,.9,.1,1) forwards;
  }
  @keyframes scareIn{
    0%{ transform: scale(.72); opacity: 0; }
    18%{ transform: scale(1.02); opacity: 1; }
    55%{ transform: scale(1.10); }
    100%{ transform: scale(1.06); }
  }

  #scareCanvas{ width:100%; height:100%; display:block; background:#000; }

  .scareScan{
    position:absolute; inset:-20%;
    background: repeating-linear-gradient(
      to bottom,
      rgba(255,255,255,.12),
      rgba(255,255,255,.12) 1px,
      rgba(0,0,0,0) 4px,
      rgba(0,0,0,0) 7px
    );
    mix-blend-mode: screen;
    opacity:.28;
    pointer-events:none;
    transform: translateY(-10%);
    animation: scanMove .35s infinite linear;
  }
  @keyframes scanMove{
    from{ transform: translateY(-10%); }
    to{ transform: translateY(10%); }
  }

  .scareVignette{
    position:absolute; inset:0;
    background: radial-gradient(circle at 50% 45%, rgba(0,0,0,0) 35%, rgba(0,0,0,.75) 78%, rgba(0,0,0,.95) 100%);
    pointer-events:none;
  }

  /* tiny strobe (limited flashes) */
  .strobe{
    position:absolute; inset:0;
    background:#fff;
    opacity:0;
    pointer-events:none;
    animation: strobe 1.15s ease-out forwards;
    mix-blend-mode: screen;
  }
  @keyframes strobe{
    0%{opacity:0}
    8%{opacity:.40}
    14%{opacity:0}
    22%{opacity:.34}
    28%{opacity:0}
    40%{opacity:.22}
    46%{opacity:0}
    100%{opacity:0}
  }
</style>
</head>

<body>
<div id="flash"></div>

<div class="appbar">
  <div class="left">
    <div class="pill"><span class="dot"></span> LIVE</div>
    <div class="title">Camera Viewer</div>
  </div>
  <div class="right">
    <div class="iconBtn" id="muteBtn" title="Sound">üîä</div>
    <div class="iconBtn" id="fsBtn" title="Fullscreen">‚§¢</div>
  </div>
</div>

<div class="wrap">
  <div class="frame" id="frame">
    <canvas id="c"></canvas>

    <div class="box" id="b1"></div>
    <div class="box" id="b2"></div>

    <div class="hud">
      <div class="hudTop">
        <div class="hudBox">
          CAM-02 ‚Ä¢ HALLWAY
          <span class="small" id="ts">--/--/---- --:--:--</span>
        </div>
        <div class="statusRow">
          <div class="tag ok" id="net">Wi-Fi OK</div>
          <div class="tag" id="fps">FPS 60</div>
          <div class="tag" id="mode">STABILISE</div>
        </div>
      </div>

      <div class="hudBottom">
        <div class="hudBox" id="msg">Loading feed‚Ä¶</div>
        <div class="hudBox" id="motion">Motion: NONE</div>
      </div>
    </div>
  </div>
</div>

<div id="tapHint">tap once for fullscreen + sound</div>

<!-- Jump scare overlay -->
<div id="scare" aria-hidden="true">
  <div class="scareWrap">
    <canvas id="scareCanvas"></canvas>
    <div class="scareScan"></div>
    <div class="strobe"></div>
    <div class="scareVignette"></div>
  </div>
</div>

<!-- Dialogs -->
<div class="dialogBackdrop" id="d1">
  <div class="dialog">
    <h3>Camera Feed Warning</h3>
    <p>We detected unusual motion in this feed. Continue?</p>
    <div class="row">
      <button class="btn btnGhost" id="d1no">Close</button>
      <button class="btn btnPrimary" id="d1ok">Continue</button>
    </div>
  </div>
</div>

<div class="dialogBackdrop" id="d2">
  <div class="dialog">
    <h3>Viewer Error</h3>
    <p>The preview may appear unstable for a moment.</p>
    <div class="row">
      <button class="btn btnPrimary" id="d2ok">View report</button>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const REPORT_URL = "../../report.html?src=scenario-b";

/* ========= Fullscreen + audio ========= */
let armed = false;
let audioCtx = null;
let masterGain = null;
let muted = false;

function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.20;
  masterGain.connect(audioCtx.destination);
}
function beep(freq=880, dur=0.06, type="square", gain=0.12){
  if(!audioCtx || muted) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = 0.0001;
  o.connect(g); g.connect(masterGain);
  const t = audioCtx.currentTime;
  g.gain.exponentialRampToValueAtTime(gain, t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
  o.start(t);
  o.stop(t + dur + 0.02);
}
async function requestFullscreen(){
  try{
    const el = document.documentElement;
    if(el.requestFullscreen) await el.requestFullscreen({ navigationUI: "hide" });
    else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
  }catch(e){}
}
async function arm(){
  if(armed) return;
  armed = true;
  const hint = document.getElementById("tapHint");
  if(hint){ hint.style.opacity = "0"; setTimeout(()=>{ try{hint.remove()}catch(e){} }, 250); }
  await requestFullscreen();
  initAudio();
  try{ await audioCtx.resume(); }catch(e){}
  beep(880,0.05,"square",0.12);
  if(navigator.vibrate) navigator.vibrate([50,30,50]);
}
document.addEventListener("pointerdown", arm, {passive:true});
document.addEventListener("keydown", arm, {passive:true});

document.getElementById("fsBtn").addEventListener("click", async ()=>{
  await arm();
  await requestFullscreen();
});
document.getElementById("muteBtn").addEventListener("click", async ()=>{
  await arm();
  muted = !muted;
  document.getElementById("muteBtn").textContent = muted ? "üîá" : "üîä";
  if(!muted) beep(660,0.05,"square",0.10);
});

/* ========= Better ‚Äúscare‚Äù sound ========= */
function playScareSound(){
  if(!audioCtx || muted) return;

  const t0 = audioCtx.currentTime;

  // Distortion
  const shaper = audioCtx.createWaveShaper();
  const curve = new Float32Array(44100);
  for(let i=0;i<curve.length;i++){
    const x = (i*2/curve.length)-1;
    curve[i] = Math.tanh(6*x);
  }
  shaper.curve = curve;

  // Master chain for scare
  const g = audioCtx.createGain();
  g.gain.value = 0.0001;

  const hp = audioCtx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.value = 180;

  const bp = audioCtx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.value = 600;
  bp.Q.value = 10;

  g.connect(hp);
  hp.connect(bp);
  bp.connect(shaper);
  shaper.connect(masterGain);

  // Noise buffer
  const dur = 1.15;
  const size = Math.floor(audioCtx.sampleRate * dur);
  const buf = audioCtx.createBuffer(1, size, audioCtx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<size;i++){
    // harsher at start, decays
    const k = 1 - (i/size);
    data[i] = (Math.random()*2-1) * (0.85*k);
  }
  const noise = audioCtx.createBufferSource();
  noise.buffer = buf;

  // Riser oscillator
  const osc = audioCtx.createOscillator();
  osc.type = "sawtooth";
  osc.frequency.setValueAtTime(140, t0);
  osc.frequency.exponentialRampToValueAtTime(1400, t0 + 0.55);
  osc.frequency.exponentialRampToValueAtTime(520, t0 + dur);

  // Bass hit
  const bass = audioCtx.createOscillator();
  bass.type = "sine";
  bass.frequency.setValueAtTime(56, t0 + 0.18);

  const bassG = audioCtx.createGain();
  bassG.gain.setValueAtTime(0.0001, t0);
  bassG.gain.exponentialRampToValueAtTime(0.32, t0 + 0.18);
  bassG.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.42);

  // Connect sources
  noise.connect(g);
  osc.connect(g);
  bass.connect(bassG);
  bassG.connect(masterGain);

  // Envelope
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(0.35, t0 + 0.08);
  g.gain.exponentialRampToValueAtTime(0.08, t0 + dur);

  // Filter sweeps (screechy)
  bp.frequency.setValueAtTime(500, t0);
  bp.frequency.exponentialRampToValueAtTime(2200, t0 + 0.45);
  bp.frequency.exponentialRampToValueAtTime(700, t0 + dur);

  // Start/stop
  noise.start(t0);
  noise.stop(t0 + dur);

  osc.start(t0);
  osc.stop(t0 + dur);

  bass.start(t0 + 0.18);
  bass.stop(t0 + 0.5);
}

/* ========= CCTV feed ========= */
const frame = document.getElementById("frame");
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d", {alpha:false});
const tsEl = document.getElementById("ts");
const msgEl = document.getElementById("msg");
const motionEl = document.getElementById("motion");
const modeEl = document.getElementById("mode");
const fpsEl = document.getElementById("fps");

function resize(){
  const r = canvas.getBoundingClientRect();
  canvas.width = Math.max(1, Math.floor(r.width));
  canvas.height = Math.max(1, Math.floor(r.height));
}
window.addEventListener("resize", resize);
resize();

let lastT = performance.now();
let frames = 0;

let tStart = performance.now();
let motionState = 0;
let glitching = false;

function nowStamp(){
  const d = new Date();
  const pad = (n)=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function drawScene(time){
  const w = canvas.width, h = canvas.height;

  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0, "#0b0c0f");
  g.addColorStop(1, "#030305");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);

  // hallway wedge
  ctx.fillStyle = "rgba(255,255,255,0.05)";
  const mid = w*0.5;
  ctx.beginPath();
  ctx.moveTo(mid - w*0.20, h);
  ctx.lineTo(mid - w*0.10, h*0.30);
  ctx.lineTo(mid + w*0.10, h*0.30);
  ctx.lineTo(mid + w*0.20, h);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "rgba(255,255,255,0.04)";
  ctx.fillRect(w*0.12, h*0.18, w*0.76, h*0.06);

  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;

  const tt = (time - tStart)/1000;
  const wave = Math.sin(tt*1.1)*0.5 + 0.5;

  for(let i=0;i<d.length;i+=4){
    const n = (Math.random()*45) | 0;
    const scan = (((i/4)/w) | 0) % 4 === 0 ? 12 : 0;
    const v = Math.min(255, n + scan);
    d[i]   = d[i]   + v;
    d[i+1] = d[i+1] + v;
    d[i+2] = d[i+2] + v;
  }
  ctx.putImageData(img,0,0);

  ctx.fillStyle = "rgba(255,255,255,0.03)";
  const bx = (wave * w*0.2);
  ctx.fillRect(bx, h*0.62, w*0.18, h*0.08);

  // vignette
  const vg = ctx.createRadialGradient(mid,h*0.55, w*0.10, mid,h*0.55, w*0.70);
  vg.addColorStop(0, "rgba(0,0,0,0)");
  vg.addColorStop(1, "rgba(0,0,0,0.65)");
  ctx.fillStyle = vg;
  ctx.fillRect(0,0,w,h);

  // burn-in labels
  ctx.font = "12px ui-monospace, Menlo, Monaco, Consolas, 'Courier New', monospace";
  ctx.fillStyle = "rgba(255,255,255,0.65)";
  ctx.fillText("REC", 12, 20);
  ctx.fillStyle = "rgba(255,59,48,0.85)";
  ctx.beginPath();
  ctx.arc(52, 16, 4, 0, Math.PI*2);
  ctx.fill();
  ctx.fillStyle = "rgba(255,255,255,0.65)";
  ctx.fillText("CAM-02", 12, 40);

  if(glitching){
    ctx.fillStyle = "rgba(255,255,255,0.12)";
    for(let k=0;k<10;k++){
      const yy = Math.random()*h;
      ctx.fillRect(0, yy, w, 2 + Math.random()*2);
    }
  }
}

function setMotion(level){
  motionState = level;
  const b1 = document.getElementById("b1");
  const b2 = document.getElementById("b2");
  b1.classList.remove("on");
  b2.classList.remove("on");

  if(level === 0){
    motionEl.textContent = "Motion: NONE";
  }else if(level === 1){
    motionEl.textContent = "Motion: LOW";
    placeBox(b1, 0.22, 0.42, 0.34, 0.26);
    b1.classList.add("on");
  }else{
    motionEl.textContent = "Motion: DETECTED";
    placeBox(b1, 0.18, 0.40, 0.38, 0.30);
    placeBox(b2, 0.54, 0.48, 0.28, 0.22);
    b1.classList.add("on");
    b2.classList.add("on");
  }
}
function placeBox(el, x, y, ww, hh){
  const r = canvas.getBoundingClientRect();
  el.style.left = (x * r.width) + "px";
  el.style.top = (y * r.height) + "px";
  el.style.width = (ww * r.width) + "px";
  el.style.height = (hh * r.height) + "px";
}

function loop(time){
  drawScene(time);
  tsEl.textContent = nowStamp();

  frames++;
  if(time - lastT >= 650){
    const fps = Math.round((frames * 1000) / (time - lastT));
    frames = 0;
    lastT = time;
    fpsEl.textContent = `FPS ${Math.max(18, Math.min(60, fps))}`;
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ========= FX helpers ========= */
function showDialog(id, show){ document.getElementById(id).style.display = show ? "flex" : "none"; }
function doFlash(){
  const f = document.getElementById("flash");
  f.style.opacity = "0.85";
  setTimeout(()=> f.style.opacity = "0", 90);
}
function glitchHit(ms=520){
  glitching = true;
  frame.classList.add("shake");
  doFlash();
  if(navigator.vibrate) navigator.vibrate([60,30,60]);
  beep(1200,0.05,"square",0.12);
  beep(240,0.12,"sawtooth",0.10);
  setTimeout(()=>{
    glitching = false;
    frame.classList.remove("shake");
  }, ms);
}

/* ========= Better jumpscare visual (draw on canvas) ========= */
const scare = document.getElementById("scare");
const scareCanvas = document.getElementById("scareCanvas");
const sctx = scareCanvas.getContext("2d", {alpha:false});
let scareRAF = null;

function resizeScare(){
  const r = scareCanvas.getBoundingClientRect();
  scareCanvas.width = Math.max(1, Math.floor(r.width));
  scareCanvas.height = Math.max(1, Math.floor(r.height));
}
window.addEventListener("resize", resizeScare);
resizeScare();

function drawScareFace(t){
  const w = scareCanvas.width, h = scareCanvas.height;
  const tt = t/1000;

  // base
  sctx.fillStyle = "#000";
  sctx.fillRect(0,0,w,h);

  // moving grain
  const img = sctx.createImageData(w,h);
  const d = img.data;
  const cx = w*0.5 + Math.sin(tt*2.2)*w*0.02;
  const cy = h*0.48 + Math.cos(tt*1.9)*h*0.02;

  for(let i=0;i<d.length;i+=4){
    const px = (i/4)%w;
    const py = ((i/4)/w)|0;
    const n = (Math.random()*255)|0;

    // radial glow near center
    const dx = (px-cx)/(w*0.42);
    const dy = (py-cy)/(h*0.42);
    const r = Math.max(0, 1 - (dx*dx + dy*dy));
    const glow = (r*r)*120;

    const v = Math.min(255, (n*0.25) + glow);
    d[i] = v; d[i+1] = v; d[i+2] = v; d[i+3] = 255;
  }
  sctx.putImageData(img,0,0);

  // eyes (bright + unsettling)
  function eye(ex,ey,rx,ry){
    const g = sctx.createRadialGradient(ex,ey, 2, ex,ey, rx);
    g.addColorStop(0, "rgba(255,255,255,0.98)");
    g.addColorStop(0.35, "rgba(255,255,255,0.55)");
    g.addColorStop(1, "rgba(255,255,255,0)");
    sctx.fillStyle = g;
    sctx.beginPath();
    sctx.ellipse(ex,ey, rx, ry, 0, 0, Math.PI*2);
    sctx.fill();

    // pupil jitter
    const px = ex + Math.sin(tt*18 + ex*0.01)*rx*0.12;
    const py = ey + Math.cos(tt*16 + ey*0.01)*ry*0.12;
    sctx.fillStyle = "rgba(0,0,0,0.95)";
    sctx.beginPath();
    sctx.ellipse(px,py, rx*0.22, ry*0.22, 0, 0, Math.PI*2);
    sctx.fill();
  }

  const pulse = 1 + Math.sin(tt*7)*0.02;
  eye(w*0.36, h*0.42, w*0.12*pulse, h*0.09*pulse);
  eye(w*0.64, h*0.42, w*0.12*pulse, h*0.09*pulse);

  // mouth
  sctx.strokeStyle = "rgba(255,255,255,0.68)";
  sctx.lineWidth = Math.max(2, w*0.01);
  sctx.beginPath();
  const mx = w*0.5, my = h*0.68;
  const mw = w*0.22, mh = h*0.12;
  sctx.ellipse(mx,my, mw, mh, 0, 0, Math.PI, false);
  sctx.stroke();

  // jitter bars
  if(Math.random()<0.35){
    sctx.fillStyle = "rgba(255,255,255,0.10)";
    for(let k=0;k<8;k++){
      const yy = Math.random()*h;
      sctx.fillRect(0, yy, w, 2 + Math.random()*3);
    }
  }

  // vignette
  const vg = sctx.createRadialGradient(w*0.5,h*0.52, w*0.12, w*0.5,h*0.52, w*0.75);
  vg.addColorStop(0, "rgba(0,0,0,0)");
  vg.addColorStop(1, "rgba(0,0,0,0.86)");
  sctx.fillStyle = vg;
  sctx.fillRect(0,0,w,h);
}

let scareBusy = false;
async function jumpScare(){
  if(scareBusy) return;
  scareBusy = true;

  await arm(); // ensure audio (Continue click is a gesture)
  resizeScare();

  // little buildup freeze + zoom on CCTV frame
  msgEl.textContent = "Signal unstable‚Ä¶";
  modeEl.textContent = "RE-SYNC";
  frame.style.transform = "scale(1.015)";
  glitchHit(340);

  setTimeout(()=>{ frame.style.transform = ""; }, 220);

  // show scare
  scare.classList.add("show");
  scare.setAttribute("aria-hidden","false");

  // sound + vibration
  playScareSound();
  if(navigator.vibrate) navigator.vibrate([90,40,90,40,140]);

  const start = performance.now();
  const run = (now)=>{
    drawScareFace(now - start);
    scareRAF = requestAnimationFrame(run);
  };
  scareRAF = requestAnimationFrame(run);

  // keep it on screen long enough to ‚Äúland‚Äù
  setTimeout(()=>{
    if(scareRAF) cancelAnimationFrame(scareRAF);
    scare.classList.remove("show");
    scare.setAttribute("aria-hidden","true");
    scareBusy = false;
  }, 1350);
}

/* ========= Timeline ========= */
msgEl.textContent = "Loading feed‚Ä¶";
modeEl.textContent = "STABILISE";
setMotion(0);

setTimeout(()=>{ msgEl.textContent = "Buffering‚Ä¶"; beep(740,0.04,"square",0.08); }, 900);
setTimeout(()=>{ msgEl.textContent = "Signal recovered"; modeEl.textContent = "LIVE"; }, 1600);
setTimeout(()=>{ setMotion(1); beep(980,0.04,"square",0.10); }, 2400);
setTimeout(()=>{ glitchHit(520); msgEl.textContent = "Motion spike"; }, 2900);
setTimeout(()=>{ setMotion(2); msgEl.textContent = "Unusual motion detected"; }, 3600);
setTimeout(()=>{ showDialog("d1", true); }, 4200);

/* Dialog actions */
document.getElementById("d1no").addEventListener("click", ()=>{
  showDialog("d1", false);
  msgEl.textContent = "Continuing‚Ä¶";
  glitchHit(420);
  setTimeout(()=> showDialog("d2", true), 900);
});

document.getElementById("d1ok").addEventListener("click", async ()=>{
  showDialog("d1", false);
  msgEl.textContent = "Continuing‚Ä¶";
  modeEl.textContent = "ANALYSE";

  // BIGGER scare right after Continue
  await jumpScare();

  // then show report prompt
  msgEl.textContent = "Viewer error detected";
  setTimeout(()=>{ showDialog("d2", true); }, 260);
});

document.getElementById("d2ok").addEventListener("click", ()=>{
  location.href = REPORT_URL;
});
</script>
</body>
</html>
